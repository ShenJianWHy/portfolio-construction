"0","# sample covariance matrix"
"0","Sigma_SCM <- cov(X_trn)"
"0",""
"0","# 1-factor model"
"0","F_ <- cbind(ones = 1, f_SP500_trn)"
"0","Gamma <- t(solve(t(F_) %*% F_, t(F_) %*% X_trn))"
"0","colnames(Gamma) <- c(""alpha"", ""beta"")"
"0","alpha <- Gamma[, 1]"
"0","beta <- Gamma[, 2]"
"0","E <- xts(t(t(X_trn) - Gamma %*% t(F_)), index(X_trn))"
"0","Psi <- (1/(T_trn-2)) * t(E) %*% E"
"0","Sigma_SP500 <- as.numeric(var(f_SP500_trn)) * beta %o% beta + diag(diag(Psi))"
"0",""
"0","# Fama-French 3-factor model"
"0","F_ <- cbind(ones = 1, F_FamaFrench_trn)"
"0","Gamma <- t(solve(t(F_) %*% F_, t(F_) %*% X_trn))"
"0","colnames(Gamma) <- c(""alpha"", ""beta1"", ""beta2"", ""beta3"")"
"0","alpha <- Gamma[, 1]"
"0","B <- Gamma[, 2:4]"
"0","E <- xts(t(t(X_trn) - Gamma %*% t(F_)), index(X_trn))"
"0","Psi <- (1/(T_trn-4)) * t(E) %*% E"
"0","Sigma_FamaFrench <- B %*% cov(F_FamaFrench_trn) %*% t(B) + diag(diag(Psi))"
"0",""
"0","# Statistical 1-factor model"
"0","K <- 1"
"0","alpha <- colMeans(X_trn)"
"0","X_trn_ <- X_trn - matrix(alpha, T_trn, N, byrow = TRUE)"
"0","Sigma_prev <- matrix(0, N, N)"
"0","Sigma <- (1/(T_trn-1)) * t(X_trn_) %*% X_trn_"
"0","eigSigma <- eigen(Sigma)"
"0","while (norm(Sigma - Sigma_prev, ""F"")/norm(Sigma, ""F"") > 1e-3) {"
"0","  B <- eigSigma$vectors[, 1:K, drop = FALSE] %*% diag(sqrt(eigSigma$values[1:K]), K, K)"
"0","  Psi <- diag(diag(Sigma - B %*% t(B)))"
"0","  Sigma_prev <- Sigma"
"0","  Sigma <- B %*% t(B) + Psi"
"0","  eigSigma <- eigen(Sigma - Psi)"
"0","}"
"0","Sigma_PCA1 <- Sigma"
"0",""
"0","# Statistical 3-factor model"
"0","K <- 3"
"0","alpha <- colMeans(X_trn)"
"0","X_trn_ <- X_trn - matrix(alpha, T_trn, N, byrow = TRUE)"
"0","Sigma_prev <- matrix(0, N, N)"
"0","Sigma <- (1/(T_trn-1)) * t(X_trn_) %*% X_trn_"
"0","eigSigma <- eigen(Sigma)"
"0","while (norm(Sigma - Sigma_prev, ""F"")/norm(Sigma, ""F"") > 1e-3) {"
"0","  B <- eigSigma$vectors[, 1:K] %*% diag(sqrt(eigSigma$values[1:K]), K, K)"
"0","  Psi <- diag(diag(Sigma - B %*% t(B)))"
"0","  Sigma_prev <- Sigma"
"0","  Sigma <- B %*% t(B) + Psi"
"0","  eigSigma <- eigen(Sigma - Psi)"
"0","}"
"0","Sigma_PCA3 <- Sigma"
"0",""
"0","# Statistical 5-factor model"
"0","K <- 5"
"0","alpha <- colMeans(X_trn)"
"0","X_trn_ <- X_trn - matrix(alpha, T_trn, N, byrow = TRUE)"
"0","Sigma_prev <- matrix(0, N, N)"
"0","Sigma <- (1/(T_trn-1)) * t(X_trn_) %*% X_trn_"
"0","eigSigma <- eigen(Sigma)"
"0","while (norm(Sigma - Sigma_prev, ""F"")/norm(Sigma, ""F"") > 1e-3) {"
"0","  B <- eigSigma$vectors[, 1:K] %*% diag(sqrt(eigSigma$values[1:K]), K, K)"
"0","  Psi <- diag(diag(Sigma - B %*% t(B)))"
"0","  Sigma_prev <- Sigma"
"0","  Sigma <- B %*% t(B) + Psi"
"0","  eigSigma <- eigen(Sigma - Psi)"
"0","}"
"0","Sigma_PCA5 <- Sigma"
